<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New York Mets Fan Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0c; /* Dark background */
            color: #e0e0e0; /* Light text color */
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1.5rem;
        }
        .section-title {
            color: #FF5910; /* Mets Orange */
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 1.5rem;
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #FF5910;
        }
        .card {
            background-color: #1a1a1a; /* Darker card background */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #333; /* Darker border */
        }
        th {
            background-color: #002D72; /* Mets Blue for table headers */
            color: white;
            font-weight: 600; /* font-semibold */
        }
        tr:hover {
            background-color: #2a2a2a; /* Slightly lighter on hover */
        }
        .score-card {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            padding: 2rem;
            background-color: #002D72; /* Solid Mets Blue */ 
            color: white;
            border-radius: 0.75rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .score-team {
            text-align: center;
        }
        .score-divider {
            margin: 0 1rem;
        }
        .game-status {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            margin-top: 1rem;
            text-align: center;
            color: #e0e0e0;
        }
        .series-navigation button, .load-more-btn {
            background-color: #002D72;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .series-navigation button:hover:not(:disabled), .load-more-btn:hover:not(:disabled) {
            background-color: #FF5910;
        }
        .series-navigation button:disabled, .load-more-btn:disabled {
            background-color: #333;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .mets-highlight {
            background-color: #004d9c !important; /* Slightly lighter Mets blue for highlighting, using !important for override */
            font-weight: bold;
            color: white;
        }
        .top-teams-table th, .top-teams-table td {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Removed Header as requested -->

        <!-- Current Score Section -->
        <section class="card">
            <h2 class="section-title">Current Game Score</h2>
            <div id="current-score" class="score-card">
                <div class="score-team">
                    <span id="home-team-name">New York Mets</span>
                    <br>
                    <span id="home-team-score">--</span>
                </div>
                <div class="score-divider">-</div>
                <div class="score-team">
                    <span id="away-team-name">Opponent</span>
                    <br>
                    <span id="away-team-score">--</span>
                </div>
            </div>
            <p id="game-status" class="game-status">Loading live game status...</p>
        </section>

        <!-- Upcoming Series Section -->
        <section class="card">
            <h2 class="section-title">Upcoming Mets Series</h2>
            <div id="upcoming-series-display" class="mb-4 text-center">
                <!-- Current series details will be displayed here -->
                <p class="text-lg font-semibold" id="current-series-info">Loading upcoming series...</p>
                <div id="current-series-games" class="mt-2 text-left inline-block">
                    <!-- Individual games in the series -->
                </div>
            </div>
            <div class="series-navigation flex justify-center space-x-4">
                <button id="prev-series-btn" disabled>Previous Series</button>
                <button id="next-series-btn" disabled>Next Series</button>
            </div>
        </section>

        <!-- Past Games Section -->
        <section class="card">
            <h2 class="section-title">Past Mets Game Results</h2>
            <div class="table-container">
                <table id="past-games-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Score</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Past games will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-4">
                <button id="load-more-past-games" class="load-more-btn">Load 5 More Games</button>
            </div>
        </section>

        <!-- Standings Section -->
        <section class="card">
            <h2 class="section-title">MLB Standings</h2>

            <h3 class="text-xl font-semibold text-white mb-4 text-center">Top 5 Teams by Win Percentage (2024 Season)</h3>
            <div class="table-container mb-8">
                <table id="top-5-teams-table" class="top-teams-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Team</th>
                            <th>W</th>
                            <th>L</th>
                            <th>PCT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Top 5 teams will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Dynamic Standings Sections will be generated here -->
            <div id="dynamic-standings-sections"></div>

        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MLB_STATS_API_HOST = "statsapi.mlb.com";
            const METS_TEAM_ID = 121; // New York Mets Team ID on MLB Stats API

            let upcomingSeries = [];
            let currentSeriesIndex = 0;
            let allPastGames = []; // To store all fetched past games
            let displayedPastGamesCount = 0;
            const GAMES_PER_LOAD = 5;

            // Mock Data for Fallback - Ensuring all divisions have mock data
            // NOTE: These mock data arrays are only used if the MLB Stats API fails to return data.
            // For live, current-season data, the API is the primary source.
            const mockUpcomingGames = [
                { date: "Sun, Jun 15, 2025", time: "01:40 PM", opponent: "Tampa Bay Rays", location: "Citi Field, New York" },
                { date: "Tue, Jun 17, 2025", time: "07:15 PM", opponent: "@ Atlanta Braves", location: "Truist Park, Atlanta" },
                { date: "Wed, Jun 18, 2025", time: "07:15 PM", opponent: "@ Atlanta Braves", location: "Truist Park, Atlanta" },
            ];

            const mockPastGames = [
                { date: "Fri, Jun 13, 2025", opponent: "Tampa Bay Rays", score: "5 - 7", result: "L" },
                { date: "Thu, Jun 12, 2025", opponent: "Washington Nationals", score: "4 - 3", result: "W" },
                { date: "Wed, Jun 11, 2025", opponent: "Washington Nationals", score: "5 - 0", result: "W" },
                { date: "Tue, Jun 10, 2025", opponent: "Washington Nationals", score: "5 - 4", result: "W (10 innings)" },
                { date: "Sun, Jun 8, 2025", opponent: "@ Colorado Rockies", score: "13 - 5", result: "W" },
                { date: "Sat, Jun 7, 2025", opponent: "@ Colorado Rockies", score: "2 - 1", result: "W" },
                { date: "Fri, Jun 6, 2025", opponent: "@ Colorado Rockies", score: "4 - 6", result: "L" },
            ];

            // Mock data reflecting a more typical 2024 end-of-season scenario for demonstration
            const mockNLEastStandings = [
                { team: { name: "Atlanta Braves" }, wins: 104, losses: 58, winningPercentage: .642, gamesBack: "-", streak: { streakCode: "W3" }, lastTenGames: "8-2" },
                { team: { name: "Philadelphia Phillies" }, wins: 90, losses: 72, winningPercentage: .556, gamesBack: "14.0", streak: { streakCode: "L1" }, lastTenGames: "6-4" },
                { team: { name: "Miami Marlins" }, wins: 84, losses: 78, winningPercentage: .519, gamesBack: "20.0", streak: { streakCode: "L2" }, lastTenGames: "5-5" },
                { team: { name: "New York Mets" }, wins: 75, losses: 87, winningPercentage: .463, gamesBack: "29.0", streak: { streakCode: "W1" }, lastTenGames: "4-6" },
                { team: { name: "Washington Nationals" }, wins: 71, losses: 91, winningPercentage: .438, gamesBack: "33.0", streak: { streakCode: "L1" }, lastTenGames: "3-7" },
            ];

            const mockALEastStandings = [
                { team: { name: "Baltimore Orioles" }, wins: 101, losses: 61, winningPercentage: .623, gamesBack: "-", streak: { streakCode: "L1" }, lastTenGames: "7-3" },
                { team: { name: "Tampa Bay Rays" }, wins: 99, losses: 63, winningPercentage: .611, gamesBack: "2.0", streak: { streakCode: "W2" }, lastTenGames: "8-2" },
                { team: { name: "Toronto Blue Jays" }, wins: 89, losses: 73, winningPercentage: .549, gamesBack: "12.0", streak: { streakCode: "W1" }, lastTenGames: "6-4" },
                { team: { name: "New York Yankees" }, wins: 82, losses: 80, winningPercentage: .506, gamesBack: "19.0", streak: { streakCode: "L3" }, lastTenGames: "4-6" },
                { team: { name: "Boston Red Sox" }, wins: 78, losses: 84, winningPercentage: .481, gamesBack: "23.0", streak: { streakCode: "W1" }, lastTenGames: "5-5" },
            ];

            const mockNLCentralStandings = [
                { team: { name: "Milwaukee Brewers" }, wins: 92, losses: 70, winningPercentage: .568, gamesBack: "-", streak: { streakCode: "W1" }, lastTenGames: "6-4" },
                { team: { name: "Chicago Cubs" }, wins: 83, losses: 79, winningPercentage: .512, gamesBack: "9.0", streak: { streakCode: "L2" }, lastTenGames: "4-6" },
                { team: { name: "Cincinnati Reds" }, wins: 82, losses: 80, winningPercentage: .506, gamesBack: "10.0", streak: { streakCode: "W1" }, lastTenGames: "5-5" },
                { team: { name: "St. Louis Cardinals" }, wins: 71, losses: 91, winningPercentage: .438, gamesBack: "21.0", streak: { streakCode: "L1" }, lastTenGames: "3-7" },
                { team: { name: "Pittsburgh Pirates" }, wins: 76, losses: 86, winningPercentage: .469, gamesBack: "16.0", streak: { streakCode: "L1" }, lastTenGames: "6-4" },
            ];
            
            const mockALCentralStandings = [
                { team: { name: "Minnesota Twins" }, wins: 87, losses: 75, winningPercentage: .537, gamesBack: "-", streak: { streakCode: "L1" }, lastTenGames: "5-5" },
                { team: { name: "Detroit Tigers" }, wins: 78, losses: 84, winningPercentage: .481, gamesBack: "9.0", streak: { streakCode: "W1" }, lastTenGames: "6-4" },
                { team: { name: "Cleveland Guardians" }, wins: 76, losses: 86, winningPercentage: .469, gamesBack: "11.0", streak: { streakCode: "L2" }, lastTenGames: "4-6" },
                { team: { name: "Chicago White Sox" }, wins: 61, losses: 101, winningPercentage: .377, gamesBack: "26.0", streak: { streakCode: "L1" }, lastTenGames: "3-7" },
                { team: { name: "Kansas City Royals" }, wins: 56, losses: 106, winningPercentage: .346, gamesBack: "31.0", streak: { streakCode: "L1" }, lastTenGames: "2-8" },
            ];

            const mockNLWestStandings = [
                { team: { name: "Los Angeles Dodgers" }, wins: 100, losses: 62, winningPercentage: .617, gamesBack: "-", streak: { streakCode: "L1" }, lastTenGames: "6-4" }, 
                { team: { name: "Arizona Diamondbacks" }, wins: 84, losses: 78, winningPercentage: .519, gamesBack: "16.0", streak: { streakCode: "W1" }, lastTenGames: "5-5" },
                { team: { name: "San Diego Padres" }, wins: 82, losses: 80, winningPercentage: .506, gamesBack: "18.0", streak: { streakCode: "W1" }, lastTenGames: "7-3" },
                { team: { name: "San Francisco Giants" }, wins: 79, losses: 83, winningPercentage: .488, gamesBack: "21.0", streak: { streakCode: "L2" }, lastTenGames: "4-6" },
                { team: { name: "Colorado Rockies" }, wins: 59, losses: 103, winningPercentage: .364, gamesBack: "41.0", streak: { streakCode: "L1" }, lastTenGames: "2-8" },
            ];

            const mockALWestStandings = [
                { team: { name: "Houston Astros" }, wins: 90, losses: 72, winningPercentage: .556, gamesBack: "-", streak: { streakCode: "W1" }, lastTenGames: "6-4" },
                { team: { name: "Texas Rangers" }, wins: 90, losses: 72, winningPercentage: .556, gamesBack: "-", streak: { streakCode: "L1" }, lastTenGames: "5-5" },
                { team: { name: "Seattle Mariners" }, wins: 88, losses: 74, winningPercentage: .543, gamesBack: "2.0", streak: { streakCode: "W2" }, lastTenGames: "7-3" },
                { team: { name: "Los Angeles Angels" }, wins: 73, losses: 89, winningPercentage: .451, gamesBack: "17.0", streak: { streakCode: "L3" }, lastTenGames: "4-6" },
                { team: { name: "Oakland Athletics" }, wins: 50, losses: 112, winningPercentage: .309, gamesBack: "40.0", streak: { streakCode: "L1" }, lastTenGames: "2-8" },
            ];


            // Helper to fetch data from MLB Stats API
            async function fetchData(path, params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const url = `https://${MLB_STATS_API_HOST}/api/v1${path}?${queryString}`;
                console.log(`Fetching from MLB Stats API: ${url}`); 
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`HTTP error! status: ${response.status}, message: ${errorText} for URL: ${url}`);
                        return null; 
                    }
                    const data = await response.json();
                    console.log(`MLB Stats API response for ${path}:`, data); 
                    // Check for common indicators of no data
                    if ((data.totalItems !== undefined && data.totalItems === 0) || 
                        (data.records && data.records.length === 0) || 
                        (data.dates && data.dates.length === 0) ||
                        (Object.keys(data).length === 0 && data.constructor === Object)) {
                        console.warn(`MLB Stats API returned empty data for ${path} with params:`, params);
                        return []; 
                    }
                    return data;
                } catch (error) {
                    console.error(`Error fetching data from MLB Stats API ${path}:`, error);
                    return null; 
                }
            }

            // Function to update current game score using MLB Stats API
            async function updateCurrentScore() {
                const homeTeamName = document.getElementById('home-team-name');
                const awayTeamName = document.getElementById('away-team-name');
                const homeTeamScore = document.getElementById('home-team-score');
                const awayTeamScore = document.getElementById('away-team-score');
                const gameStatus = document.getElementById('game-status');
                
                gameStatus.textContent = "Loading live game status...";

                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;

                const scheduleData = await fetchData('/schedule', {
                    date: formattedDate,
                    sportId: 1, // MLB
                });

                if (scheduleData && scheduleData.dates && scheduleData.dates.length > 0) {
                    const gamesToday = scheduleData.dates[0].games;
                    const metsGame = gamesToday.find(game => 
                        (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                        (game.status.codedGameState === "I" || game.status.codedGameState === "P" || game.status.codedGameState === "D") 
                    );

                    if (metsGame) {
                        homeTeamName.textContent = metsGame.teams.home.team.name || "Unknown";
                        awayTeamName.textContent = metsGame.teams.away.team.name || "Unknown";
                        homeTeamScore.textContent = metsGame.teams.home.score !== undefined ? metsGame.teams.home.score : "--";
                        awayTeamScore.textContent = metsGame.teams.away.score !== undefined ? metsGame.teams.away.score : "--";
                        
                        let currentStatus = metsGame.status.detailedState;

                        if (metsGame.status.codedGameState === "I") {
                            // Display inning without ordinal suffix, if available
                            if (metsGame.inningInfo?.currentInning) {
                                currentStatus = `${metsGame.inningInfo.inningHalf || ''} ${metsGame.inningInfo.currentInning}`;
                            } else {
                                currentStatus = "In Progress"; // Fallback if inning number isn't there
                            }
                        } else if (metsGame.status.codedGameState === "P" || metsGame.status.codedGameState === "S") {
                            const gameTime = new Date(metsGame.gameDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                            currentStatus = `Scheduled: ${gameTime}`;
                        } else if (metsGame.status.codedGameState === "F" || metsGame.status.codedGameState === "O") {
                            currentStatus = "Final"; 
                        }

                        gameStatus.textContent = currentStatus;

                    } else {
                        gameStatus.textContent = "No live Mets game currently.";
                        homeTeamName.textContent = "New York Mets";
                        awayTeamName.textContent = "Opponent";
                        homeTeamScore.textContent = "--";
                        awayTeamScore.textContent = "--";
                    }
                } else {
                    gameStatus.textContent = "No games scheduled for today or data unavailable from MLB Stats API.";
                    homeTeamName.textContent = "New York Mets";
                    awayTeamName.textContent = "Opponent";
                    homeTeamScore.textContent = "--";
                    awayTeamScore.textContent = "--";
                }
            }
            
            // Function to populate upcoming series
            async function populateUpcomingSeries() {
                const today = new Date();
                const year = today.getFullYear();
                const futureDate = new Date();
                futureDate.setDate(today.getDate() + 90); // Look ahead 90 days for series

                const formattedToday = `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const formattedFutureDate = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}-${String(futureDate.getDate()).padStart(2, '0')}`;

                const scheduleData = await fetchData('/schedule', {
                    startDate: formattedToday,
                    endDate: formattedFutureDate,
                    teamId: METS_TEAM_ID,
                    sportId: 1, // MLB
                    sort: 'gameDate'
                });

                upcomingSeries = []; // Clear previous series
                if (scheduleData && scheduleData.dates) {
                    const allMetsGames = scheduleData.dates.flatMap(dateEntry => 
                        dateEntry.games.filter(game => 
                            (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                            (game.status.codedGameState === "S" || game.status.codedGameState === "P" || game.status.codedGameState === "D") // Scheduled, Pre-Game, Delayed
                        )
                    ).sort((a, b) => new Date(a.gameDate) - new Date(b.gameDate)); // Ensure sorted by date


                    // Group games into series
                    let currentSeries = null;
                    allMetsGames.forEach(game => {
                        const opponent = game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.team : game.teams.home.team;
                        const location = (game.venue && game.venue.name) || "Unknown Venue";
                        const gameDate = new Date(game.gameDate);

                        // Define series break conditions:
                        // 1. New opponent
                        // 2. Different location (home vs away series)
                        // 3. More than 2 days gap between games in the same series
                        if (!currentSeries || currentSeries.opponent.id !== opponent.id || currentSeries.location !== location || 
                            (gameDate - currentSeries.lastGameDate) / (1000 * 60 * 60 * 24) > 2) {
                            
                            currentSeries = {
                                opponent: opponent,
                                location: location,
                                startDate: gameDate,
                                lastGameDate: gameDate,
                                games: [game]
                            };
                            upcomingSeries.push(currentSeries);
                        } else {
                            currentSeries.games.push(game);
                            currentSeries.lastGameDate = gameDate;
                        }
                    });
                }

                currentSeriesIndex = 0; // Reset to first series
                renderUpcomingSeries();
            }

            function renderUpcomingSeries() {
                const seriesInfoDiv = document.getElementById('current-series-info');
                const seriesGamesDiv = document.getElementById('current-series-games');
                const prevBtn = document.getElementById('prev-series-btn');
                const nextBtn = document.getElementById('next-series-btn');

                seriesGamesDiv.innerHTML = ''; // Clear previous games list

                if (upcomingSeries.length > 0) {
                    const series = upcomingSeries[currentSeriesIndex];
                    const startDateFormatted = new Date(series.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endDateFormatted = new Date(series.lastGameDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    let opponentName = series.opponent.name;
                    if (series.games[0] && series.games[0].teams.home.team.id !== METS_TEAM_ID) {
                        opponentName = `@ ${opponentName}`;
                    }

                    seriesInfoDiv.textContent = `${opponentName} at ${series.location} (${startDateFormatted} - ${endDateFormatted})`;

                    series.games.forEach(game => {
                        const gameDateTime = new Date(game.gameDate);
                        const gameDate = gameDateTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        const gameTime = gameDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        const gameDiv = document.createElement('p');
                        gameDiv.textContent = `${gameDate} - ${gameTime}`;
                        seriesGamesDiv.appendChild(gameDiv);
                    });

                    prevBtn.disabled = currentSeriesIndex === 0;
                    nextBtn.disabled = currentSeriesIndex === upcomingSeries.length - 1;
                } else {
                    seriesInfoDiv.textContent = "No upcoming Mets series found.";
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                }
            }

            // Event Listeners for Series Navigation
            document.getElementById('prev-series-btn').addEventListener('click', () => {
                if (currentSeriesIndex > 0) {
                    currentSeriesIndex--;
                    renderUpcomingSeries();
                }
            });

            document.getElementById('next-series-btn').addEventListener('click', () => {
                if (currentSeriesIndex < upcomingSeries.length - 1) {
                    currentSeriesIndex++;
                    renderUpcomingSeries();
                }
            });


            // Function to populate past games tables using MLB Stats API
            async function populatePastGames() {
                const today = new Date();
                const year = today.getFullYear();
                
                // Fetch games for a longer period initially to allow "load more"
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 90); // Look back 90 days

                const formattedPastDate = `${pastDate.getFullYear()}-${String(pastDate.getMonth() + 1).padStart(2, '0')}-${String(pastDate.getDate()).padStart(2, '0')}`;
                const formattedToday = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const scheduleData = await fetchData('/schedule', {
                    startDate: formattedPastDate,
                    endDate: formattedToday, 
                    teamId: METS_TEAM_ID,
                    sportId: 1, // MLB
                });

                let gamesFromApi = [];
                if (scheduleData && scheduleData.dates) {
                    gamesFromApi = scheduleData.dates.flatMap(dateEntry => 
                        dateEntry.games.filter(game => 
                            (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                            (game.status.codedGameState === "F" || game.status.codedGameState === "O") // F: Final, O: Completed (Official)
                        )
                    );
                }

                // Sort all fetched past games by date descending (most recent first)
                gamesFromApi.sort((a, b) => new Date(b.gameDate) - new Date(a.gameDate));
                allPastGames = gamesFromApi.length > 0 ? gamesFromApi : mockPastGames.sort((a, b) => new Date(b.date) - new Date(a.date)); // Fallback & sort mock

                displayedPastGamesCount = 0; // Reset count
                renderPastGames(); // Initial render of first 5 games
            }

            function renderPastGames() {
                const tableBody = document.querySelector(`#past-games-table tbody`);
                const loadMoreBtn = document.getElementById('load-more-past-games');
                
                // Clear only if this is the initial render, otherwise append
                if (displayedPastGamesCount === 0) {
                    tableBody.innerHTML = ''; 
                }

                const gamesToRender = allPastGames.slice(displayedPastGamesCount, displayedPastGamesCount + GAMES_PER_LOAD);

                if (gamesToRender.length > 0) {
                    gamesToRender.forEach(game => {
                        const row = tableBody.insertRow();
                        
                        const isApiData = game.gamePk !== undefined; 

                        let gameDate, opponentName, metsScore, opponentScore, result;

                        if (isApiData) {
                            const gameDateTime = new Date(game.gameDate);
                            gameDate = gameDateTime.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

                            opponentName = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.team.name : game.teams.home.team.name) || "Unknown Opponent";
                            
                            metsScore = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.home.score : game.teams.away.score);
                            opponentScore = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.score : game.teams.home.score);
                            result = (metsScore > opponentScore) ? 'W' : (metsScore < opponentScore ? 'L' : 'TBD');
                        } else { // Mock data
                            gameDate = game.date;
                            opponentName = game.opponent;
                            metsScore = (game.score && game.score.split(' - ')[0]) || '--';
                            opponentScore = (game.score && game.score.split(' - ')[1]) || '--';
                            result = game.result;
                        }

                        row.insertCell().textContent = gameDate;
                        row.insertCell().textContent = opponentName;
                        row.insertCell().textContent = `${metsScore || '--'} - ${opponentScore || '--'}`;
                        row.insertCell().textContent = result;
                    });
                    displayedPastGamesCount += gamesToRender.length;
                } else if (displayedPastGamesCount === 0) { // Only show message if no games loaded initially
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = `No past games found or data unavailable from MLB Stats API.`;
                    cell.className = "text-center py-4";
                }

                loadMoreBtn.disabled = displayedPastGamesCount >= allPastGames.length;
                loadMoreBtn.style.display = allPastGames.length > GAMES_PER_LOAD ? 'block' : 'none'; // Only show if more games exist
            }

            document.getElementById('load-more-past-games').addEventListener('click', renderPastGames);


            // Function to populate standings tables using MLB Stats API
            async function populateStandings() {
                // IMPORTANT: Fetching 2024 season data for accurate standings as 2025 data may be incomplete/unavailable
                const seasonToFetch = 2024; 

                // Fetch NL standings (includes NL East, Central, West)
                const nlStandingsData = await fetchData('/standings', {
                    leagueId: 103, // National League ID
                    season: seasonToFetch,
                    standingsTypes: 'regularSeason'
                });
                
                // Fetch AL standings (includes AL East, Central, West)
                const alStandingsData = await fetchData('/standings', {
                    leagueId: 104, // American League ID
                    season: seasonToFetch,
                    standingsTypes: 'regularSeason'
                });

                const dynamicStandingsSections = document.getElementById('dynamic-standings-sections');
                dynamicStandingsSections.innerHTML = ''; // Clear previous dynamic sections

                let allTeams = []; // To collect all teams for top 5

                // Helper to create and populate a single standings table
                const createAndPopulateStandingsTable = (apiRecords, mockData, divisionName, divisionId) => {
                    // Correctly access teamRecords from API response
                    const divisionApiData = apiRecords && apiRecords.records ? apiRecords.records.find(record => record.division.id === divisionId)?.teamRecords : null;
                    let dataToDisplay = [];

                    if (divisionApiData && divisionApiData.length > 0) {
                        dataToDisplay = divisionApiData;
                        console.log(`API data for ${divisionName}:`, dataToDisplay); // Log API data
                    } else {
                        dataToDisplay = mockData;
                        console.log(`Using mock data for ${divisionName}:`, dataToDisplay); // Log mock data
                    }

                    // Add teams from this division to allTeams for overall top 5 calculation
                    dataToDisplay.forEach(teamRecord => {
                        const teamObj = {};
                        // Safely get team name and winning percentage for both API and mock data structures
                        const currentTeamName = (teamRecord.team && typeof teamRecord.team === 'object' && teamRecord.team.name) ? teamRecord.team.name : (typeof teamRecord.team === 'string' ? teamRecord.team : "Unknown Team");
                        teamObj.team = { name: currentTeamName };
                        
                        teamObj.wins = teamRecord.wins !== undefined ? teamRecord.wins : teamRecord.W;
                        teamObj.losses = teamRecord.losses !== undefined ? teamRecord.losses : teamRecord.L;
                        teamObj.winningPercentage = teamRecord.winningPercentage !== undefined ? parseFloat(teamRecord.winningPercentage) : parseFloat(teamRecord.PCT);
                        
                        // Only add to allTeams if winningPercentage is a valid number and team name is not "Unknown Team"
                        if (currentTeamName !== "Unknown Team" && !isNaN(teamObj.winningPercentage)) {
                             allTeams.push(teamObj);
                        }
                    });
                    console.log(`All teams array after processing ${divisionName}:`, allTeams); // Log allTeams array building

                    // Custom sort: Mets first, then by winning percentage, then alphabetically
                    dataToDisplay.sort((a, b) => {
                        const teamA = (a.team && typeof a.team === 'object' && a.team.name) ? a.team.name : (typeof a.team === 'string' ? a.team : "");
                        const teamB = (b.team && typeof b.team === 'object' && b.team.name) ? b.team.name : (typeof b.team === 'string' ? b.team : "");

                        if (teamA === "New York Mets" && teamB !== "New York Mets") return -1;
                        if (teamB === "New York Mets" && teamA !== "New York Mets") return 1;

                        const pctA = parseFloat(a.winningPercentage || a.PCT || 0);
                        const pctB = parseFloat(b.winningPercentage || b.PCT || 0);

                        if (pctA !== pctB) {
                            return pctB - pctA; // Sort by PCT descending
                        }
                        return teamA.localeCompare(teamB); // Alphabetical if PCT is same
                    });


                    // Create elements for this division
                    const divisionHeader = document.createElement('h3');
                    divisionHeader.className = "text-xl font-semibold text-white mb-4 text-center mt-8";
                    divisionHeader.textContent = divisionName;
                    dynamicStandingsSections.appendChild(divisionHeader);

                    const tableContainer = document.createElement('div');
                    tableContainer.className = "table-container mb-8";
                    dynamicStandingsSections.appendChild(tableContainer);

                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>W</th>
                                <th>L</th>
                                <th>PCT</th>
                                <th>GB</th>
                                <th>STRK</th>
                                <th>L10</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    tableContainer.appendChild(table);
                    const tableBody = table.querySelector('tbody');

                    if (dataToDisplay && dataToDisplay.length > 0) {
                        dataToDisplay.forEach(teamRecord => {
                            const row = tableBody.insertRow();
                            // Safely access properties for both API and mock data structures
                            const teamName = (teamRecord.team && typeof teamRecord.team === 'object' && teamRecord.team.name) ? teamRecord.team.name : (typeof teamRecord.team === 'string' ? teamRecord.team : "Unknown Team");
                            const wins = teamRecord.wins !== undefined ? teamRecord.wins : teamRecord.W;
                            const losses = teamRecord.losses !== undefined ? teamRecord.losses : teamRecord.L;
                            const pct = teamRecord.winningPercentage !== undefined ? parseFloat(teamRecord.winningPercentage).toFixed(3) : (typeof teamRecord.PCT === 'string' ? teamRecord.PCT : '--');
                            const gb = teamRecord.gamesBack !== undefined ? teamRecord.gamesBack : teamRecord.GB;
                            const streak = teamRecord.streak ? (teamRecord.streak.streakCode || '--') : teamRecord.STRK; 
                            const lastTen = teamRecord.lastTenGames || teamRecord.L10 || '--'; 

                            row.insertCell().textContent = teamName;
                            row.insertCell().textContent = wins || '--';
                            row.insertCell().textContent = losses || '--';
                            row.insertCell().textContent = pct || '--';
                            row.insertCell().textContent = gb !== null ? gb : '-'; 
                            row.insertCell().textContent = streak;
                            row.insertCell().textContent = lastTen;

                            if (teamName === "New York Mets") {
                                row.classList.add('mets-highlight');
                            }
                        });
                    } else {
                        const row = tableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 7;
                        cell.textContent = `${divisionName} Standings data unavailable.`;
                        cell.className = "text-center py-4";
                    }
                };
                
                // --- National League Divisions ---
                createAndPopulateStandingsTable(nlStandingsData, mockNLEastStandings, "NL East Standings", 203);
                createAndPopulateStandingsTable(nlStandingsData, mockNLCentralStandings, "NL Central Standings", 204);
                createAndPopulateStandingsTable(nlStandingsData, mockNLWestStandings, "NL West Standings", 205);


                // --- American League Divisions ---
                createAndPopulateStandingsTable(alStandingsData, mockALEastStandings, "AL East Standings", 201);
                createAndPopulateStandingsTable(alStandingsData, mockALCentralStandings, "AL Central Standings", 202);
                createAndPopulateStandingsTable(alStandingsData, mockALWestStandings, "AL West Standings", 200);

                // Populate Top 5 Teams
                const top5TeamsTableBody = document.getElementById('top-5-teams-table').querySelector('tbody');
                top5TeamsTableBody.innerHTML = ''; // Clear existing rows

                // Filter out teams with no valid winning percentage and sort for top 5
                console.log("All teams before final filter/sort for Top 5:", allTeams); // Debugging
                const teamsWithValidPct = allTeams.filter(team => team.winningPercentage !== undefined && team.winningPercentage !== null && !isNaN(parseFloat(team.winningPercentage)) && team.team.name !== "Unknown Team");
                console.log("Teams with valid PCT and known names for Top 5:", teamsWithValidPct); // Debugging

                teamsWithValidPct.sort((a, b) => {
                    return (parseFloat(b.winningPercentage) || 0) - (parseFloat(a.winningPercentage) || 0);
                });

                const top5Teams = teamsWithValidPct.slice(0, 5);
                console.log("Final Top 5 Teams:", top5Teams); // Debugging

                if (top5Teams.length > 0) {
                    top5Teams.forEach((team, index) => {
                        const row = top5TeamsTableBody.insertRow();
                        row.insertCell().textContent = index + 1;
                        row.insertCell().textContent = team.team.name || "Unknown Team";
                        row.insertCell().textContent = team.wins || '--';
                        row.insertCell().textContent = team.losses || '--';
                        row.insertCell().textContent = team.winningPercentage !== undefined ? parseFloat(team.winningPercentage).toFixed(3) : '--';
                    });
                } else {
                    const row = top5TeamsTableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 5;
                    cell.textContent = "No top teams data available or valid teams to display.";
                    cell.className = "text-center py-4";
                }
            }


            async function initializeApp() {
                await updateCurrentScore();
                await populateUpcomingSeries(); 
                await populatePastGames(); 
                await populateStandings();
            }

            initializeApp();

            // The app updates every 5 minutes.
            setInterval(initializeApp, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
