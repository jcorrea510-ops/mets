<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New York Mets Fan Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #100F1C; /* Deep dark background */
            color: #E0E0E0; /* Light gray text */
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1.5rem 0; /* Add vertical padding for overall content */
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: auto;
            padding: 1.5rem;
            background-color: #1A1A2E; /* Slightly lighter dark blue/purple tint */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); /* Softer, deeper shadow */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .section-title {
            color: #FF5910; /* Mets Orange */
            font-size: 2.25rem; /* text-4xl, slightly larger */
            font-weight: 800; /* font-extrabold */
            margin-bottom: 1.5rem;
            text-align: center;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #002D72; /* Thicker Mets Blue border */
            text-shadow: 0 0 10px rgba(255, 89, 16, 0.3); /* Subtle orange glow */
        }
        .card {
            background-color: #252440; /* Even lighter, more vibrant dark tint for cards */
            border-radius: 1rem; /* Consistent rounded corners */
            padding: 2rem; /* More padding inside cards */
            margin-bottom: 2rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* Card specific shadow */
            border: 1px solid rgba(70, 70, 90, 0.3); /* Subtle border for depth */
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
        }
        .table-container {
            overflow-x: auto; /* Still allow scrolling if content unexpectedly wide */
            border-radius: 0.75rem; /* Rounded corners for table container */
            background-color: #1A1A2E; /* Match container background */
        }
        table {
            width: 100%;
            border-collapse: separate; /* Use separate to allow border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
            margin-top: 0; /* No margin as it's inside container */
            background-color: #1A1A2E; /* Match container background for inner table */
            border-radius: 0.75rem; /* Apply to table */
            table-layout: fixed; /* Crucial for fixed column widths */
        }
        th, td {
            padding: 1rem; /* More padding in table cells */
            text-align: left;
            border-bottom: 1px solid #3A3A4A; /* Lighter, subtle border */
            color: #E0E0E0;
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis for overflowing text by default */
            white-space: nowrap; /* Prevent wrapping by default */
        }
        th {
            background-color: #002D72; /* Mets Blue for table headers */
            color: white;
            font-weight: 700; /* font-bold */
            position: sticky; /* Make headers sticky for scrolling tables */
            top: 0;
            z-index: 10;
        }
        /* Top-left rounded corner for first th */
        th:first-child {
            border-top-left-radius: 0.75rem;
        }
        /* Top-right rounded corner for last th */
        th:last-child {
            border-top-right-radius: 0.75rem;
        }
        tr:last-child td {
            border-bottom: none; /* No border on last row */
        }
        tr:nth-child(even) {
            background-color: #202038; /* Slightly different shade for even rows */
        }
        tr:hover {
            background-color: #353450; /* More distinct hover for rows */
            cursor: pointer; /* Indicate clickable rows */
        }

        /* Responsive adjustments for score card */
        .score-card {
            display: flex;
            justify-content: space-between; /* Space between teams */
            align-items: center;
            font-weight: 800; /* font-extrabold */
            padding: 1.5rem; /* Default padding */
            background: linear-gradient(135deg, #002D72 0%, #004d9c 100%); /* Gradient background */
            color: white;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 45, 114, 0.5); /* Enhanced shadow with blue glow */
            margin-bottom: 2rem;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.7); /* Stronger text shadow */
            flex-wrap: nowrap; /* Prevent wrapping of the two main team blocks */
        }
        .score-team {
            flex-grow: 1;
            flex-shrink: 1;
            flex-basis: 45%; /* Each team takes almost half the width */
            text-align: center;
            padding: 0 0.2rem; /* Minimal horizontal padding */
            min-width: 80px; /* Ensure a minimum width to avoid crushing */
        }
        .score-team span:first-child { /* Team Name */
            font-size: 1.25rem; /* Default mobile font size */
            font-weight: 700;
            white-space: normal; /* ALLOW WRAPPING for readability */
            overflow: visible; /* Ensure text is not hidden */
            text-overflow: clip; /* No ellipsis when wrapping */
            display: block; /* Ensures name and score stack cleanly within its own team block */
            line-height: 1.2; /* Better line height for wrapping text */
            margin-bottom: 0.2rem; /* Add some space if name wraps */
        }
        .score-team span:last-child { /* Score */
            font-size: 3rem; /* Default mobile score font size */
            display: block;
            line-height: 1; /* Tighter line height for numbers */
        }
        .score-divider {
            display: block; /* Ensure it's visible */
            font-size: 3rem;
            font-weight: 800;
            margin: 0 0.5rem;
            color: #FF5910;
            flex-shrink: 0; /* Prevent dash from shrinking */
            flex-basis: auto; /* Allow dash to take only necessary space */
        }

        /* Mobile specific overrides for screens smaller than 640px */
        @media (max-width: 639px) {
            .score-card {
                padding: 0.8rem 0.5rem; /* Reduced padding for overall card */
            }
            .score-team span:first-child {
                font-size: 1rem; /* Slightly smaller team name for general mobile */
            }
            .score-team span:last-child {
                font-size: 2.2rem; /* Slightly smaller score for general mobile */
            }
            .score-divider {
                font-size: 2.2rem; /* Match smaller score font */
                margin: 0 0.2rem; /* Very tight margin for the dash */
            }
            .score-team {
                padding: 0 0.1rem; /* Minimal padding around each team block */
                flex-basis: calc(50% - 0.5rem); /* Distribute space more evenly, accounting for divider width */
                min-width: 90px; /* Ensure a good minimum width */
            }
            /* Adjust game status font for mobile */
            .game-status {
                font-size: 1rem; /* Smaller font for game status on small mobile */
                margin-top: 1rem; /* Reduce top margin */
            }
        }

        /* Further adjustments for extremely small mobile screens (e.g., iPhone SE/smaller iPhones) */
        @media (max-width: 380px) {
            .score-team span:first-child {
                font-size: 0.85rem; /* Even smaller team name */
            }
            .score-team span:last-child {
                font-size: 1.8rem; /* Even smaller score */
            }
            .score-divider {
                font-size: 1.8rem; /* Match even smaller score font */
                margin: 0 0.1rem; /* Ultra-tight margin */
            }
            .score-team {
                 min-width: 80px; /* Further reduce min-width if necessary */
            }
        }

        @media (min-width: 640px) { /* sm breakpoint and up - Desktop styles */
            .score-card {
                font-size: 2.5rem; /* text-5xl for larger screens */
                padding: 2.5rem; /* More padding on larger screens */
            }
            .score-team {
                flex: none; /* Reset flex for larger screens */
                padding: 0;
            }
            .score-team span:first-child {
                font-size: 1.5rem; /* text-2xl */
            }
            .score-team span:last-child {
                font-size: 4rem; /* text-6xl */
            }
            .score-divider {
                font-size: 4rem; /* Match score size */
                margin: 0 1rem; /* Standard margin */
            }
        }

        .game-status {
            font-size: 1.25rem; /* text-xl for mobile */
            font-weight: 600;
            margin-top: 1.5rem;
            text-align: center;
            color: #C0C0C0; /* Slightly muted gray for status */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        @media (min-width: 768px) { /* md breakpoint */
            .game-status {
                font-size: 1.5rem; /* text-2xl for medium and up */
            }
        }
        .series-navigation button, .load-more-btn {
            background: linear-gradient(90deg, #002D72 0%, #004d9c 100%); /* Gradient button */
            color: white;
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.75rem; /* More rounded */
            font-weight: bold;
            transition: all 0.3s ease; /* Smooth transition for all properties */
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .series-navigation button:hover:not(:disabled), .load-more-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #FF5910 0%, #E64E0F 100%); /* Orange gradient on hover */
            transform: translateY(-2px); /* Slight lift */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), 0 0 15px rgba(255, 89, 16, 0.4); /* Enhanced glow */
        }
        .series-navigation button:disabled, .load-more-btn:disabled {
            background-color: #333;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        .mets-highlight {
            background-color: #004d9c !important; /* Slightly lighter Mets blue for highlighting, using !important for override */
            font-weight: bold;
            color: white;
        }
        .note-text {
            font-size: 0.875rem; /* text-sm */
            color: #999999; /* Muted gray */
            text-align: center;
            margin-top: 1rem;
            line-height: 1.4;
        }

        /* Past Games Table Column Widths */
        #past-games-table th:nth-child(1), #past-games-table td:nth-child(1) { /* Date */
            width: 30%; /* Increased width for "Weekday MM/DD" */
        }
        #past-games-table th:nth-child(2), #past-games-table td:nth-child(2) { /* Opponent */
            width: 35%; /* Adjusted to compensate */
            white-space: normal; /* Allow opponent name to wrap */
            text-overflow: clip; /* No ellipsis needed if wrapping */
        }
        #past-games-table th:nth-child(3), #past-games-table td:nth-child(3) { /* S (Score) */
            width: 20%;
        }
        #past-games-table th:nth-child(4), #past-games-table td:nth-child(4) { /* R (Result) */
            width: 15%;
        }

        /* Reduce table padding for screens smaller than 640px */
        @media (max-width: 639px) {
            #past-games-table th, #past-games-table td {
                padding: 0.6rem; /* Reduced padding */
                font-size: 0.9rem; /* Slightly smaller font for table on small screens */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Current Score Section -->
        <section class="card">
            <h2 class="section-title">Current Game Score</h2>
            <div id="current-score" class="score-card">
                <div class="score-team">
                    <span id="home-team-name">New York Mets</span>
                    <br>
                    <span id="home-team-score">--</span>
                </div>
                <div class="score-divider">-</div>
                <div class="score-team">
                    <span id="away-team-name">Opponent</span>
                    <br>
                    <span id="away-team-score">--</span>
                </div>
            </div>
            <p id="game-status" class="game-status">Loading live game status...</p>
        </section>

        <!-- Upcoming Series Section -->
        <section class="card">
            <h2 class="section-title">Upcoming Mets Series</h2>
            <div id="upcoming-series-display" class="mb-4 text-center">
                <!-- Current series details will be displayed here -->
                <p class="text-lg font-semibold" id="current-series-info">Loading upcoming series...</p>
                <div id="current-series-games" class="mt-2 text-left inline-block">
                    <!-- Individual games in the series -->
                </div>
            </div>
            <div class="series-navigation flex justify-center space-x-4">
                <button id="prev-series-btn" disabled>Previous Series</button>
                <button id="next-series-btn" disabled>Next Series</button>
            </div>
        </section>

        <!-- Past Games Section -->
        <section class="card">
            <h2 class="section-title">Past Mets Game Results</h2>
            <div class="table-container">
                <table id="past-games-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>S</th> <!-- Changed from Score to S -->
                            <th>R</th> <!-- Changed from Result to R -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Past games will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-4">
                <button id="load-more-past-games" class="load-more-btn">Load 5 More Games</button>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MLB_STATS_API_HOST = "statsapi.mlb.com";
            const METS_TEAM_ID = 121; // New York Mets Team ID on MLB Stats API

            let upcomingSeries = [];
            let currentSeriesIndex = 0;
            let allPastGames = []; // To store all fetched past games
            let displayedPastGamesCount = 0;
            const GAMES_PER_LOAD = 5;

            // Mock data for past and upcoming games are kept for robustness in schedule sections
            // Removed year from mock data
            const mockUpcomingGames = [
                { date: "Sun, Jun 15", time: "01:40 PM", opponent: "Tampa Bay Rays", location: "Citi Field, New York" },
                { date: "Tue, Jun 17", time: "07:15 PM", opponent: "@ Atlanta Braves", location: "Truist Park, Atlanta" },
                { date: "Wed, Jun 18", time: "07:15 PM", opponent: "@ Atlanta Braves", location: "Truist Park, Atlanta" },
            ];

            // Updated mock data to use "Day MM/DD" format directly for consistency
            const mockPastGames = [
                { date: "Fri 6/13", opponent: "Tampa Bay Rays", score: "5 - 7", result: "L", gamePk: '719000' },
                { date: "Thu 6/12", opponent: "Washington Nationals", score: "4 - 3", result: "W", gamePk: '719001' },
                { date: "Wed 6/11", opponent: "Washington Nationals", score: "5 - 0", result: "W", gamePk: '719002' },
                { date: "Tue 6/10", opponent: "Washington Nationals", score: "5 - 4", result: "W (10 innings)", gamePk: '719003' },
                { date: "Sun 6/8", opponent: "@ Colorado Rockies", score: "13 - 5", result: "W", gamePk: '719004' },
                { date: "Sat 6/7", opponent: "@ Colorado Rockies", score: "2 - 1", result: "W", gamePk: '719005' },
                { date: "Fri 6/6", opponent: "@ Colorado Rockies", score: "4 - 6", result: "L", gamePk: '719006' },
            ];


            // Helper to fetch data from MLB Stats API
            async function fetchData(path, params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const url = `https://${MLB_STATS_API_HOST}/api/v1${path}?${queryString}`;
                console.log(`Fetching from MLB Stats API: ${url}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`HTTP error! status: ${response.status}, message: ${errorText} for URL: ${url}`);
                        return null;
                    }
                    const data = await response.json();
                    console.log(`MLB Stats API response for ${path}:`, data);
                    // Check for common indicators of no data
                    if ((data.totalItems !== undefined && data.totalItems === 0) ||
                        (data.records && data.records.length === 0) ||
                        (data.dates && data.dates.length === 0) ||
                        (Object.keys(data).length === 0 && data.constructor === Object)) {
                        console.warn(`MLB Stats API returned empty data for ${path} with params:`, params);
                        return [];
                    }
                    return data;
                } catch (error) {
                    console.error(`Error fetching data from MLB Stats API ${path}:`, error);
                    return null;
                }
            }

            // Function to update current game score using MLB Stats API
            async function updateCurrentScore() {
                const homeTeamName = document.getElementById('home-team-name');
                const awayTeamName = document.getElementById('away-team-name');
                const homeTeamScore = document.getElementById('home-team-score');
                const awayTeamScore = document.getElementById('away-team-score');
                const gameStatus = document.getElementById('game-status');

                gameStatus.textContent = "Loading live game status...";

                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${today.getFullYear()}-${month}-${day}`; // Keep year for API call only

                const scheduleData = await fetchData('/schedule', {
                    date: formattedDate,
                    sportId: 1, // MLB
                });

                if (scheduleData && scheduleData.dates && scheduleData.dates.length > 0) {
                    const gamesToday = scheduleData.dates[0].games;
                    const metsGame = gamesToday.find(game =>
                        (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                        (game.status.codedGameState === "I" || game.status.codedGameState === "P" || game.status.codedGameState === "D")
                    );

                    if (metsGame) {
                        homeTeamName.textContent = metsGame.teams.home.team.name || "Unknown";
                        awayTeamName.textContent = metsGame.teams.away.team.name || "Unknown";
                        homeTeamScore.textContent = metsGame.teams.home.score !== undefined ? metsGame.teams.home.score : "--";
                        awayTeamScore.textContent = metsGame.teams.away.score !== undefined ? metsGame.teams.away.score : "--";

                        let currentStatus = metsGame.status.detailedState;

                        if (metsGame.status.codedGameState === "I") {
                            // Display inning and half, e.g., "Inning: Top 3rd"
                            if (metsGame.inningInfo?.currentInning && metsGame.inningInfo?.inningHalf) {
                                currentStatus = `Inning: ${metsGame.inningInfo.inningHalf} ${metsGame.inningInfo.currentInning}`;
                            } else {
                                currentStatus = "Game In Progress"; // Fallback if inning number isn't there
                            }
                        } else if (metsGame.status.codedGameState === "P" || metsGame.status.codedGameState === "S") {
                            const gameTime = new Date(metsGame.gameDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                            currentStatus = `Scheduled: ${gameTime}`;
                        } else if (metsGame.status.codedGameState === "F" || metsGame.status.codedGameState === "O") {
                            currentStatus = "Final";
                        }

                        gameStatus.textContent = currentStatus;

                    } else {
                        gameStatus.textContent = "No live Mets game currently.";
                        homeTeamName.textContent = "New York Mets";
                        awayTeamName.textContent = "Opponent";
                        homeTeamScore.textContent = "--";
                        awayTeamScore.textContent = "--";
                    }
                } else {
                    gameStatus.textContent = "No games scheduled for today or data unavailable from MLB Stats API.";
                    homeTeamName.textContent = "New York Mets";
                    awayTeamName.textContent = "Opponent";
                    homeTeamScore.textContent = "--";
                    awayTeamScore.textContent = "--";
                }
            }

            // Function to populate upcoming series
            async function populateUpcomingSeries() {
                const today = new Date();
                const year = today.getFullYear();
                const futureDate = new Date();
                futureDate.setDate(today.getDate() + 90); // Look ahead 90 days for series

                const formattedToday = `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const formattedFutureDate = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}-${String(futureDate.getDate()).padStart(2, '0')}`;

                const scheduleData = await fetchData('/schedule', {
                    startDate: formattedToday,
                    endDate: formattedFutureDate,
                    teamId: METS_TEAM_ID,
                    sportId: 1, // MLB
                    sort: 'gameDate'
                });

                upcomingSeries = []; // Clear previous series
                if (scheduleData && scheduleData.dates) {
                    const allMetsGames = scheduleData.dates.flatMap(dateEntry =>
                        dateEntry.games.filter(game =>
                            (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                            (game.status.codedGameState === "S" || game.status.codedGameState === "P" || game.status.codedGameState === "D") // Scheduled, Pre-Game, Delayed
                        )
                    ).sort((a, b) => new Date(a.gameDate) - new Date(b.gameDate)); // Ensure sorted by date


                    // Group games into series
                    let currentSeries = null;
                    allMetsGames.forEach(game => {
                        const opponent = game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.team : game.teams.home.team;
                        // Removed location variable and usage
                        const gameDate = new Date(game.gameDate);

                        // Define series break conditions:
                        // 1. New opponent
                        // 2. More than 2 days gap between games in the same series (removed location check)
                        if (!currentSeries || currentSeries.opponent.id !== opponent.id ||
                            (gameDate - currentSeries.lastGameDate) / (1000 * 60 * 60 * 24) > 2) {

                            currentSeries = {
                                opponent: opponent,
                                startDate: gameDate,
                                lastGameDate: gameDate,
                                games: [game]
                            };
                            upcomingSeries.push(currentSeries);
                        } else {
                            currentSeries.games.push(game);
                            currentSeries.lastGameDate = gameDate;
                        }
                    });
                }

                currentSeriesIndex = 0; // Reset to first series
                renderUpcomingSeries();
            }

            function renderUpcomingSeries() {
                const seriesInfoDiv = document.getElementById('current-series-info');
                const seriesGamesDiv = document.getElementById('current-series-games');
                const prevBtn = document.getElementById('prev-series-btn');
                const nextBtn = document.getElementById('next-series-btn');

                seriesGamesDiv.innerHTML = ''; // Clear previous games list

                if (upcomingSeries.length > 0) {
                    const series = upcomingSeries[currentSeriesIndex];
                    const startDateFormatted = new Date(series.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endDateFormatted = new Date(series.lastGameDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    let opponentName = series.opponent.name;
                    if (series.games[0] && series.games[0].teams.home.team.id !== METS_TEAM_ID) {
                        opponentName = `@ ${opponentName}`;
                    }

                    // Removed location from seriesInfoDiv textContent
                    seriesInfoDiv.textContent = `${opponentName} (${startDateFormatted} - ${endDateFormatted})`;

                    series.games.forEach(game => {
                        const gameDateTime = new Date(game.gameDate);
                        const gameDate = gameDateTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        const gameTime = gameDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        const gameDiv = document.createElement('p');
                        gameDiv.textContent = `${gameDate} - ${gameTime}`;
                        seriesGamesDiv.appendChild(gameDiv);
                    });

                    prevBtn.disabled = currentSeriesIndex === 0;
                    nextBtn.disabled = currentSeriesIndex === upcomingSeries.length - 1;
                } else {
                    seriesInfoDiv.textContent = "No upcoming Mets series found.";
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                }
            }

            // Event Listeners for Series Navigation
            document.getElementById('prev-series-btn').addEventListener('click', () => {
                if (currentSeriesIndex > 0) {
                    currentSeriesIndex--;
                    renderUpcomingSeries();
                }
            });

            document.getElementById('next-series-btn').addEventListener('click', () => {
                if (currentSeriesIndex < upcomingSeries.length - 1) {
                    currentSeriesIndex++;
                    renderUpcomingSeries();
                }
            });

            // Function to populate past games tables using MLB Stats API
            async function populatePastGames() {
                const today = new Date();
                const year = today.getFullYear(); // Keep year for API call to fetch correct season data

                // Fetch games for a longer period initially to allow "load more"
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 90); // Look back 90 days

                const formattedPastDate = `${pastDate.getFullYear()}-${String(pastDate.getMonth() + 1).padStart(2, '0')}-${String(pastDate.getDate()).padStart(2, '0')}`;
                const formattedToday = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const scheduleData = await fetchData('/schedule', {
                    startDate: formattedPastDate,
                    endDate: formattedToday,
                    teamId: METS_TEAM_ID,
                    sportId: 1, // MLB
                });

                let gamesFromApi = [];
                if (scheduleData && scheduleData.dates) {
                    gamesFromApi = scheduleData.dates.flatMap(dateEntry =>
                        dateEntry.games.filter(game =>
                            (game.teams.home.team.id === METS_TEAM_ID || game.teams.away.team.id === METS_TEAM_ID) &&
                            (game.status.codedGameState === "F" || game.status.codedGameState === "O") // F: Final, O: Completed (Official)
                        )
                    );
                }

                // Sort all fetched past games by date descending (most recent first)
                gamesFromApi.sort((a, b) => new Date(b.gameDate) - new Date(a.gameDate));
                allPastGames = gamesFromApi.length > 0 ? gamesFromApi : mockPastGames.sort((a, b) => {
                    // Custom sort for mock data as it has string dates in "Day MM/DD" format
                    const todayYear = new Date().getFullYear();
                    const parseDate = (dateStr) => {
                        const [dayOfWeek, monthDay] = dateStr.split(' ');
                        const [month, day] = monthDay.split('/').map(Number);
                        // Using current year for mock data to make dates sortable
                        return new Date(todayYear, month - 1, day);
                    };
                    return parseDate(b.date) - parseDate(a.date);
                });

                displayedPastGamesCount = 0; // Reset count
                renderPastGames(); // Initial render of first 5 games
            }

            function renderPastGames() {
                const tableBody = document.querySelector(`#past-games-table tbody`);
                const loadMoreBtn = document.getElementById('load-more-past-games');

                // Clear only if this is the initial render, otherwise append
                if (displayedPastGamesCount === 0) {
                    tableBody.innerHTML = '';
                }

                const gamesToRender = allPastGames.slice(displayedPastGamesCount, displayedPastGamesCount + GAMES_PER_LOAD);

                if (gamesToRender.length > 0) {
                    gamesToRender.forEach(game => {
                        const row = tableBody.insertRow();

                        const isApiData = game.gamePk !== undefined;

                        let gameDate, opponentName, metsScore, opponentScore, result;

                        if (isApiData) {
                            const gameDateTime = new Date(game.gameDate);
                            // New date format: "Day MM/DD" e.g., "Sat 6/15" to ensure 8 characters if possible
                            const weekday = gameDateTime.toLocaleDateString('en-US', { weekday: 'short' }); // e.g., "Sat"
                            const month = (gameDateTime.getMonth() + 1).toString(); // e.g., "6"
                            const day = gameDateTime.getDate().toString(); // e.g., "15"
                            gameDate = `${weekday} ${month}/${day}`; // Combines to "Sat 6/15"

                            opponentName = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.team.name : game.teams.home.team.name) || "Unknown Opponent";

                            metsScore = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.home.score : game.teams.away.score);
                            opponentScore = (game.teams.home.team.id === METS_TEAM_ID ? game.teams.away.score : game.teams.home.score);
                            result = (metsScore > opponentScore) ? 'W' : (metsScore < opponentScore ? 'L' : 'TBD');
                        } else { // Mock data
                            gameDate = game.date; // Mock data is already in "Day MM/DD" format
                            opponentName = game.opponent;
                            metsScore = (game.score && game.score.split(' - ')[0]) || '--';
                            opponentScore = (game.score && game.score.split(' - ')[1]) || '--';
                            result = game.result;
                        }

                        row.insertCell().textContent = gameDate;
                        row.insertCell().textContent = opponentName;
                        row.insertCell().textContent = `${metsScore || '--'} - ${opponentScore || '--'}`;
                        row.insertCell().textContent = result;
                    });
                    displayedPastGamesCount += gamesToRender.length;
                } else if (displayedPastGamesCount === 0) { // Only show message if no games loaded initially
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = `No past games found or data unavailable from MLB Stats API.`;
                    cell.className = "text-center py-4";
                }

                loadMoreBtn.disabled = displayedPastGamesCount >= allPastGames.length;
                loadMoreBtn.style.display = allPastGames.length > GAMES_PER_LOAD ? 'block' : 'none'; // Only show if more games exist
            }

            document.getElementById('load-more-past-games').addEventListener('click', renderPastGames);

            async function initializeApp() {
                await updateCurrentScore();
                await populateUpcomingSeries();
                await populatePastGames();
            }

            initializeApp();

            // The app updates every 5 minutes.
            setInterval(initializeApp, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
